
#Read all csv files inside folder that contains all audit files within uuids folders
read_all_csv<-function(folder){
  filenames<-list.files(path = folder,recursive = T)
  filenames<-paste0(folder,filenames)
  filenames<-grep("\\.csv$",filenames,value = TRUE)

  dfs<-purrr::map(filenames,read.csv)
  names(dfs)<-sub(".*/(.*)/.*","\\1",filenames)
  dfs
}

#Remove all information and keep only question xml name in the node column
sanitize_node <- function(expression) {
  sub("/.*/","",expression)
}

#Form duration
calculate_survey_duration <- function(endtime, startime){
  as.numeric(round(sum(((endtime - startime)/60000),na.rm = T),digits = 2))
}

#Form lifetime from start to end, save and exit
form_lifetime <- function(endtime, startime){
  as.numeric(round((tail(endtime[!is.na(endtime)],1) - startime[1])/60000,digits = 2))
}

allaudit<-read_all_csv("audit/")
allaudit<-lapply(allaudit, function(x) {
    x$node<-sanitize_node(x$node)
    return(x)
  })

# time spent answering questions
time_spent_questions<-lapply(allaudit, function(x){
  calculate_survey_duration(x$end[x$event %in% c("question","group questions")],
                            x$start[x$event %in% c("question","group questions")])
}) %>% unlist()

# from start of survey to save and exit
form_lifetime<-lapply(allaudit, function(x){
  form_lifetime(x$end, x$start)
}) %>% unlist()

# time spent on GPS/comme,taire/merci
gps_comm_merci<-lapply(allaudit, function(x){
  calculate_survey_duration(x$end[x$node %in% c("q0_gps","commentaires","merci")],
                            x$start[x$node %in% c("q0_gps","commentaires","merci")])
}) %>% unlist()

#time spent answering question excluding gps/commenatire/merci
real_duration<-time_spent_questions-gps_comm_merci

data.frame(form_lifetime=form_lifetime,
           time_spent_questions=time_spent_questions,
           real_duration=real_duration) %>% write.csv("audit.csv", row.names = T)

count_event_type<-function(allaudit, event){
  lapply(allaudit, function(x){
    sum(str_count(x$event, event))
  }) %>% unlist()
}

